<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dia a Dia</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- √çcones (Feather Icons) -->
    <script src="https://unpkg.com/feather-icons"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .completed > div > .task-text { text-decoration: line-through; color: #9ca3af; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-button { background-color: white; color: #374151; }
        .tab-button:hover { background-color: #f3f4f6; }
        .tab-button.active { color: white; }
        
        .history-sub-tab-content { display: none; }
        .history-sub-tab-content.active { display: block; }
        .history-sub-tab-button { background-color: #f9fafb; color: #4b5563; }
        .history-sub-tab-button.active { background-color: #4f46e5; color: white; }

        .timeline { border-left: 3px solid #e5e7eb; }
        .timeline-item { position: relative; }
        .timeline-item:before {
            content: '';
            position: absolute;
            left: -9px;
            top: 50%;
            transform: translateY(-50%);
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-4xl">

        <header class="text-center mb-6">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900">Dia a Dia</h1>
            <p id="current-date" class="text-gray-600 mt-2 text-lg"></p>
        </header>

        <div id="tabs" class="mb-6 flex flex-wrap justify-center gap-2">
            <button data-tab="geral" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Vis√£o Geral</button>
            <button data-tab="trabalho" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Trabalho</button>
            <button data-tab="estudo" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Estudo</button>
            <button data-tab="atividade-fisica" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Atividade F√≠sica</button>
            <button data-tab="alimentacao" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Alimenta√ß√£o</button>
            <button data-tab="saude" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Sa√∫de</button>
            <button data-tab="historico" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Hist√≥rico</button>
            <button data-tab="configuracoes" class="tab-button py-2 px-4 rounded-lg font-semibold transition-colors duration-200">Configura√ß√µes</button>
        </div>

        <main id="tab-contents">
            <div id="geral" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">‚ú® Timeline do Dia</h2>
                <ul id="geral-list" class="space-y-3 mb-4"></ul>
                <div class="mt-8 pt-6 border-t-2 border-gray-100">
                    <h2 class="text-2xl font-semibold text-gray-700 mb-4">üìà Relat√≥rio de Progresso</h2>
                    <div id="report-summary" class="text-center p-4 rounded-lg bg-gray-50 mb-6"></div>
                    <div id="report-details" class="space-y-4"></div>
                    <div id="pending-tasks-summary" class="mt-8 pt-4 border-t">
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Tarefas Pendentes</h3>
                        <ul id="pending-tasks-list" class="space-y-2"></ul>
                    </div>
                </div>
            </div>
            <div id="trabalho" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            <div id="estudo" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            <div id="atividade-fisica" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            <div id="alimentacao" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            <div id="saude" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200"></div>
            
            <div id="historico" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-semibold text-gray-700">üìú Hist√≥rico de Tarefas</h2>
                    <div id="history-sub-tabs" class="flex gap-2 p-1 bg-gray-100 rounded-lg">
                        <button data-subtab="lista" class="history-sub-tab-button py-1 px-3 rounded-md text-sm font-semibold transition-colors">Lista</button>
                        <button data-subtab="timeline" class="history-sub-tab-button py-1 px-3 rounded-md text-sm font-semibold transition-colors">Linha do Tempo</button>
                    </div>
                </div>
                <div id="history-sub-tab-contents">
                    <div id="history-lista" class="history-sub-tab-content space-y-6"></div>
                    <div id="history-timeline" class="history-sub-tab-content space-y-6"></div>
                </div>
            </div>

            <div id="configuracoes" class="tab-content bg-white p-6 rounded-2xl shadow-md border border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-700 mb-6">‚öôÔ∏è Configura√ß√µes</h2>
                <div class="border-t pt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Gerenciar Tarefas Fixas</h3>
                    <p class="text-gray-600 mb-4">Tarefas adicionadas aqui aparecer√£o automaticamente todos os dias.</p>
                    
                    <form id="add-fixed-task-form" class="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end bg-gray-50 p-4 rounded-lg mb-6">
                        <div class="sm:col-span-2">
                            <label for="fixed-task-text" class="block text-sm font-medium text-gray-700">Descri√ß√£o da Tarefa</label>
                            <input type="text" id="fixed-task-text" placeholder="Ex: Tomar vitamina" class="mt-1 block w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none" required>
                        </div>
                        <div>
                            <label for="fixed-task-time" class="block text-sm font-medium text-gray-700">Hor√°rio</label>
                            <input type="time" id="fixed-task-time" class="mt-1 block w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                        </div>
                         <div>
                            <label for="fixed-task-category" class="block text-sm font-medium text-gray-700">Categoria</label>
                            <select id="fixed-task-category" class="mt-1 block w-full p-2 border rounded-md focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white">
                                <!-- Op√ß√µes preenchidas via JS -->
                            </select>
                        </div>
                        <div class="sm:col-span-4">
                             <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition-colors">Adicionar Tarefa Fixa</button>
                        </div>
                    </form>

                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Lista de Tarefas Fixas</h4>
                    <ul id="fixed-tasks-list" class="space-y-2">
                        <!-- Lista de tarefas fixas renderizada aqui -->
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabsContainer = document.getElementById('tabs');
        const tabContentsContainer = document.getElementById('tab-contents');
        const dateDisplay = document.getElementById('current-date');
        let tasks = {};
        let history = {};
        let fixedTasks = [];

        const categoryConfig = {
            geral:            { prefix: 'text-gray-500',   activeTab: 'bg-gray-600',   checkbox: 'text-gray-600',   ring: 'ring-gray-500',   icon: '‚ú®', title: 'Vis√£o Geral', timeline: 'border-gray-500' },
            trabalho:         { prefix: 'text-blue-500',   activeTab: 'bg-blue-600',   checkbox: 'text-blue-600',   ring: 'ring-blue-500',   icon: 'üíº', title: 'Trabalho', timeline: 'border-blue-500' },
            estudo:           { prefix: 'text-yellow-500', activeTab: 'bg-yellow-500', checkbox: 'text-yellow-500', ring: 'ring-yellow-500', icon: 'üìö', title: 'Estudo', timeline: 'border-yellow-500' },
            'atividade-fisica': { prefix: 'text-red-500',    activeTab: 'bg-red-600',    checkbox: 'text-red-600',    ring: 'ring-red-500',    icon: 'üí™', title: 'Atividade F√≠sica', timeline: 'border-red-500' },
            alimentacao:      { prefix: 'text-green-500',  activeTab: 'bg-green-600',  checkbox: 'text-green-600',  ring: 'ring-green-500',  icon: 'üçé', title: 'Alimenta√ß√£o', timeline: 'border-green-500' },
            saude:            { prefix: 'text-purple-500', activeTab: 'bg-purple-600', checkbox: 'text-purple-600', ring: 'ring-purple-500', icon: '‚ù§Ô∏è', title: 'Sa√∫de', timeline: 'border-purple-500' },
            historico:        { prefix: 'text-indigo-500', activeTab: 'bg-indigo-600', checkbox: 'text-indigo-600', ring: 'ring-indigo-500', icon: 'üìú', title: 'Hist√≥rico', timeline: 'border-indigo-500' },
            configuracoes:    { prefix: 'text-gray-500',   activeTab: 'bg-gray-800',   checkbox: 'text-gray-800',   ring: 'ring-gray-800',   icon: '‚öôÔ∏è', title: 'Configura√ß√µes' }
        };

        // --- L√ìGICA DE DADOS ---

        function loadFixedTasks() {
            const saved = localStorage.getItem('fixedTasks');
            fixedTasks = saved ? JSON.parse(saved) : [];
        }

        function saveFixedTasks() {
            localStorage.setItem('fixedTasks', JSON.stringify(fixedTasks));
        }

        function generateInitialTasks() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const dayOfMonth = today.getDate();
            
            // CORRE√á√ÉO: Come√ßa com as tarefas originais hardcoded
            const newTasks = {
                trabalho: [
                    { id: Date.now() + 1, text: 'Subir Volumetria', time: '07:50', completed: false },
                    { id: Date.now() + 2, text: 'Preparar Fup', time: '08:00', completed: false },
                    { id: Date.now() + 3, text: 'Falta de Volume', time: '08:20', completed: false },
                    { id: Date.now() + 4, text: 'Analisar rotas da expedi√ß√£o no Web Varejo', time: '09:00', completed: false }
                ],
                estudo: [],
                'atividade-fisica': [],
                alimentacao: [
                    { id: Date.now() + 5, text: '1¬∞ Refei√ß√£o - Pr√©-dia', time: '05:20', completed: false },
                    { id: Date.now() + 6, text: '2¬∞ Refei√ß√£o - Caf√© da manh√£', time: '06:40', completed: false },
                    { id: Date.now() + 7, text: '3¬∞ Refei√ß√£o - Lanche da manh√£', time: '09:30', completed: false },
                    { id: Date.now() + 8, text: '4¬∞ Refei√ß√£o - Almo√ßo', time: '12:30', completed: false },
                    { id: Date.now() + 9, text: '5¬∞ Refei√ß√£o - Pr√©-treino', time: '15:30', completed: false },
                    { id: Date.now() + 10, text: '6¬∞ Refei√ß√£o - Jantar', time: '20:00', completed: false }
                ],
                saude: [ { id: Date.now() + 11, text: 'Tomar creatina', time: '07:10', completed: false } ]
            };

            // CORRE√á√ÉO: Adiciona as tarefas fixas personalizadas √† lista existente
            fixedTasks.forEach(task => {
                if (newTasks[task.category]) {
                    newTasks[task.category].push({ ...task, id: Date.now() + Math.random(), completed: false });
                }
            });
            
            // Adiciona tarefas din√¢micas do dia
            const workoutPlan = ['Domingo: Ombro, panturrilha e ABS', 'Segunda: Perna', 'Ter√ßa: Costas, b√≠ceps e trap√©zio', 'Quarta: Peito, tr√≠ceps e ombro', 'Quinta: Costas, b√≠ceps', 'Sexta: Peito e tr√≠ceps', 'S√°bado: Baba'];
            let workoutTime = '18:30';
            if (dayOfWeek === 6) workoutTime = '06:00';
            if (dayOfWeek === 0) workoutTime = '08:00';
            newTasks['atividade-fisica'].push({ id: Date.now() + 12, text: workoutPlan[dayOfWeek], time: workoutTime, completed: false });

            if (dayOfWeek >= 1 && dayOfWeek <= 6) {
                const studyTopic = (dayOfMonth % 2 === 0) ? 'PROGRAMA√á√ÉO DE SOLU√á√ïES COMPUTACIONAIS' : 'MODELAGEM DE SOFTWARE';
                newTasks.estudo.push({ id: Date.now() + 13, text: `Estudar a noite: ${studyTopic}`, time: '21:00', completed: false });
            }
            if (dayOfMonth % 2 !== 0) {
                newTasks.estudo.push({ id: Date.now() + 14, text: 'Estudar curso de BI e Excel', time: '21:00', completed: false });
            }
            return newTasks;
        }

        function getTodayKey() { return new Date().toLocaleDateString('pt-BR'); }
        function loadTasks() {
            const todayStorageKey = `dailyTasks-${getTodayKey()}`;
            const savedTasks = localStorage.getItem(todayStorageKey);
            tasks = savedTasks ? JSON.parse(savedTasks) : generateInitialTasks();
            saveTasks();
        }
        function saveTasks() {
            const todayStorageKey = `dailyTasks-${getTodayKey()}`;
            localStorage.setItem(todayStorageKey, JSON.stringify(tasks));
        }
        function loadHistory() {
            const savedHistory = localStorage.getItem('tasksHistory');
            history = savedHistory ? JSON.parse(savedHistory) : {};
        }
        function saveHistory() { localStorage.setItem('tasksHistory', JSON.stringify(history)); }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO ---

        function displayDate() {
            const now = new Date();
            const days = ['Domingo', 'Segunda-feira', 'Ter√ßa-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'S√°bado'];
            dateDisplay.textContent = `${days[now.getDay()]}, ${now.toLocaleDateString('pt-BR')}`;
        }

        function createTaskElement(task, categoryForElement) {
            const li = document.createElement('li');
            li.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 transition-colors duration-150';
            if (task.completed) li.classList.add('completed');
            const taskCategory = task.category || categoryForElement;
            const colors = categoryConfig[taskCategory];
            const isGeneralView = categoryForElement === 'geral';
            const prefix = isGeneralView ? `<span class="text-xs font-bold uppercase ${colors.prefix} mr-2">${taskCategory.replace('-', ' ')}:</span>` : '';
            li.innerHTML = `
                <div class="flex items-center flex-grow min-w-0">
                    <span class="font-semibold text-gray-500 w-14 text-left">${task.time || ''}</span>
                    <input type="checkbox" data-id="${task.id}" data-category="${taskCategory}" class="h-5 w-5 rounded border-gray-300 ${colors.checkbox} focus:${colors.ring} flex-shrink-0 mx-3" ${task.completed ? 'checked' : ''}>
                    <span class="task-text text-lg text-gray-700 truncate">${prefix}${task.text}</span>
                </div>
                <button class="remove-task-btn text-gray-400 hover:text-red-500 transition-colors ml-2" data-id="${task.id}" data-category="${taskCategory}">
                    <i data-feather="trash-2" class="w-5 h-5"></i>
                </button>`;
            return li;
        }

        function renderCategoryTab(category) {
            const config = categoryConfig[category];
            const container = document.getElementById(category);
            if(category === 'historico' || category === 'configuracoes') return;
            container.innerHTML = `
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">${config.icon} ${config.title}</h2>
                <ul id="${category}-list" class="space-y-3 mb-4"></ul>
                <form class="add-task-form flex flex-wrap gap-2 items-center">
                    <input type="text" placeholder="Nova tarefa..." class="flex-grow p-2 border rounded-lg focus:ring-2 focus:${config.ring} focus:outline-none">
                    <input type="time" class="p-2 border rounded-lg focus:ring-2 focus:${config.ring} focus:outline-none">
                    <button type="submit" class="${config.activeTab} text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition-opacity">Adicionar</button>
                </form>`;
        }
        
        function renderReport() {
            const reportSummaryEl = document.getElementById('report-summary');
            const reportDetailsEl = document.getElementById('report-details');
            const pendingTasksListEl = document.getElementById('pending-tasks-list');
            reportDetailsEl.innerHTML = '';
            pendingTasksListEl.innerHTML = '';
            let totalTasks = 0, totalCompleted = 0;
            const allPendingTasks = [];
            const now = new Date(), currentHours = now.getHours(), currentMinutes = now.getMinutes();

            Object.keys(tasks).forEach(category => {
                const categoryTasks = tasks[category];
                if (categoryTasks.length === 0) return;
                const config = categoryConfig[category];
                const categoryCompleted = categoryTasks.filter(t => t.completed).length;
                const categoryTotal = categoryTasks.length;
                const percentage = categoryTotal > 0 ? (categoryCompleted / categoryTotal) * 100 : 0;
                totalTasks += categoryTotal;
                totalCompleted += categoryCompleted;
                categoryTasks.forEach(task => { if (!task.completed) allPendingTasks.push({ ...task, category }); });
                const detailDiv = document.createElement('div');
                detailDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-semibold ${config.prefix}">${config.icon} ${config.title}</span>
                        <span class="text-sm font-medium text-gray-500">${categoryCompleted} / ${categoryTotal}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-4"><div class="${config.activeTab} h-4 rounded-full transition-all duration-500" style="width: ${percentage}%"></div></div>`;
                reportDetailsEl.appendChild(detailDiv);
            });
            
            allPendingTasks.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));
            allPendingTasks.forEach(task => {
                const config = categoryConfig[task.category];
                let status = { text: 'Pendente', color: 'text-gray-500' };
                if (task.time) {
                    const [taskHours, taskMinutes] = task.time.split(':').map(Number);
                    if (taskHours < currentHours || (taskHours === currentHours && taskMinutes < currentMinutes)) status = { text: 'Atrasado', color: 'text-red-500' };
                }
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center';
                li.innerHTML = `<span class="text-gray-600">${task.time ? `[${task.time}]` : ''} ${task.text} (${config.title})</span><span class="font-semibold text-sm ${status.color}">${status.text}</span>`;
                pendingTasksListEl.appendChild(li);
            });

            const overallPercentage = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;
            reportSummaryEl.innerHTML = `<p class="text-lg text-gray-600">Progresso Geral</p><p class="text-4xl font-bold text-gray-800">${overallPercentage}%</p><p class="text-md text-gray-500">${totalCompleted} de ${totalTasks} tarefas conclu√≠das</p>`;
            if (pendingTasksListEl.children.length === 0 && totalTasks > 0) pendingTasksListEl.innerHTML = '<li class="text-center text-gray-500">Parab√©ns! Todas as tarefas foram conclu√≠das.</li>';
            else if (totalTasks === 0) pendingTasksListEl.innerHTML = '<li class="text-center text-gray-500">Nenhuma tarefa para hoje.</li>';
        }

        function renderHistory() {
            const historyListEl = document.getElementById('history-lista');
            const historyTimelineEl = document.getElementById('history-timeline');
            historyListEl.innerHTML = '';
            historyTimelineEl.innerHTML = '';

            const sortedDates = Object.keys(history).sort((a, b) => {
                const [dayA, monthA, yearA] = a.split('/');
                const [dayB, monthB, yearB] = b.split('/');
                return new Date(`${yearB}-${monthB}-${dayB}`) - new Date(`${yearA}-${monthA}-${dayA}`);
            });

            if (sortedDates.length === 0) {
                const emptyMsg = '<p class="text-center text-gray-500">Nenhuma tarefa foi conclu√≠da ainda.</p>';
                historyListEl.innerHTML = emptyMsg;
                historyTimelineEl.innerHTML = emptyMsg;
                return;
            }

            sortedDates.forEach(date => {
                const tasksForDay = history[date];
                if (tasksForDay.length === 0) return;
                tasksForDay.sort((a, b) => (a.completedAt || '99:99').localeCompare(b.completedAt || '99:99'));

                const listDayContainer = document.createElement('div');
                listDayContainer.innerHTML = `<h3 class="text-xl font-bold text-gray-800 pb-2 mb-2 border-b">${date}</h3>`;
                const listElement = document.createElement('ul');
                listElement.className = 'space-y-2';
                tasksForDay.forEach(task => {
                    const config = categoryConfig[task.category];
                    listElement.innerHTML += `<li class="flex items-center text-gray-600"><span class="font-semibold w-20">[${task.completedAt}]</span><span class="font-bold ${config.prefix} mr-2">${config.icon}</span><span>${task.text}</span></li>`;
                });
                listDayContainer.appendChild(listElement);
                historyListEl.appendChild(listDayContainer);

                const timelineDayContainer = document.createElement('div');
                timelineDayContainer.innerHTML = `<h3 class="text-xl font-bold text-gray-800 pb-2 mb-4">${date}</h3>`;
                const timelineElement = document.createElement('div');
                timelineElement.className = 'timeline ml-4 pl-8 space-y-4';
                tasksForDay.forEach(task => {
                    const config = categoryConfig[task.category];
                    timelineElement.innerHTML += `
                        <div class="timeline-item ${config.timeline}">
                            <div class="flex items-center gap-4">
                                <span class="font-bold text-gray-700">${task.completedAt}</span>
                                <div class="flex items-center gap-2 p-2 bg-gray-50 rounded-lg flex-grow">
                                    <span class="font-bold ${config.prefix}">${config.icon}</span>
                                    <span class="text-gray-800">${task.text}</span>
                                </div>
                            </div>
                        </div>`;
                });
                timelineDayContainer.appendChild(timelineElement);
                historyTimelineEl.appendChild(timelineDayContainer);
            });
        }

        function renderFixedTasksList() {
            const listEl = document.getElementById('fixed-tasks-list');
            listEl.innerHTML = '';
            if (fixedTasks.length === 0) {
                listEl.innerHTML = '<li class="text-center text-gray-500">Nenhuma tarefa fixa adicionada.</li>';
                return;
            }
            fixedTasks.forEach((task, index) => {
                const config = categoryConfig[task.category];
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-2 rounded-lg bg-gray-50';
                li.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-semibold text-gray-600 w-14">${task.time || 'N/A'}</span>
                        <span class="font-bold ${config.prefix}">${config.icon}</span>
                        <span class="text-gray-800">${task.text}</span>
                    </div>
                    <button class="remove-fixed-task-btn text-gray-400 hover:text-red-500 transition-colors" data-index="${index}">
                        <i data-feather="trash-2" class="w-5 h-5"></i>
                    </button>
                `;
                listEl.appendChild(li);
            });
            feather.replace();
        }

        function renderAll() {
            const geralList = document.getElementById('geral-list');
            geralList.innerHTML = '';
            const allTasksFlat = Object.keys(tasks).flatMap(category => tasks[category].map(task => ({ ...task, category })));
            allTasksFlat.sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99'));
            allTasksFlat.forEach(task => geralList.appendChild(createTaskElement(task, 'geral')));
            
            Object.keys(tasks).forEach(category => {
                const listElement = document.getElementById(`${category}-list`);
                if(listElement) {
                    listElement.innerHTML = '';
                    tasks[category].sort((a, b) => (a.time || '99:99').localeCompare(b.time || '99:99')).forEach(task => listElement.appendChild(createTaskElement(task, category)));
                }
            });
            renderReport();
            renderHistory();
            renderFixedTasksList();
            feather.replace();
        }

        // --- L√ìGICA DE EVENTOS ---
        tabsContainer.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const targetTab = e.target.dataset.tab;
                tabsContainer.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                    Object.values(categoryConfig).forEach(color => btn.classList.remove(color.activeTab));
                });
                e.target.classList.add('active', categoryConfig[targetTab].activeTab);
                tabContentsContainer.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(targetTab).classList.add('active');
            }
        });

        document.getElementById('history-sub-tabs').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const targetSubTab = e.target.dataset.subtab;
                document.querySelectorAll('.history-sub-tab-button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                document.querySelectorAll('.history-sub-tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(`history-${targetSubTab}`).classList.add('active');
            }
        });

        tabContentsContainer.addEventListener('submit', (e) => {
            if (e.target.classList.contains('add-task-form')) {
                e.preventDefault();
                const form = e.target;
                const textInput = form.querySelector('input[type="text"]');
                const timeInput = form.querySelector('input[type="time"]');
                const taskText = textInput.value.trim();
                const taskTime = timeInput.value;
                const category = form.closest('.tab-content').id;
                if (taskText) {
                    tasks[category].push({ id: Date.now(), text: taskText, time: taskTime, completed: false });
                    textInput.value = ''; timeInput.value = '';
                    saveTasks();
                    renderAll();
                }
            }
        });
        
        tabContentsContainer.addEventListener('click', (e) => {
            const checkbox = e.target.closest('input[type="checkbox"]');
            const removeBtn = e.target.closest('.remove-task-btn');
            
            if (checkbox) {
                const taskId = Number(checkbox.dataset.id);
                const category = checkbox.dataset.category;
                const task = tasks[category].find(t => t.id === taskId);
                if (task) {
                    task.completed = checkbox.checked;
                    const todayKey = getTodayKey();
                    if (!history[todayKey]) history[todayKey] = [];
                    if (task.completed) {
                        const alreadyInHistory = history[todayKey].some(ht => ht.id === taskId);
                        if (!alreadyInHistory) {
                            const now = new Date();
                            const hours = String(now.getHours()).padStart(2, '0');
                            const minutes = String(now.getMinutes()).padStart(2, '0');
                            history[todayKey].push({ ...task, category: category, completedAt: `${hours}:${minutes}` });
                        }
                    } else {
                        history[todayKey] = history[todayKey].filter(ht => ht.id !== taskId);
                    }
                    saveTasks();
                    saveHistory();
                    renderAll();
                }
            }

            if (removeBtn) {
                const taskId = Number(removeBtn.dataset.id);
                const category = removeBtn.dataset.category;
                tasks[category] = tasks[category].filter(task => task.id !== taskId);
                const todayKey = getTodayKey();
                if (history[todayKey]) history[todayKey] = history[todayKey].filter(ht => ht.id !== taskId);
                saveTasks();
                saveHistory();
                renderAll();
            }
        });

        document.getElementById('add-fixed-task-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const text = document.getElementById('fixed-task-text').value.trim();
            const time = document.getElementById('fixed-task-time').value;
            const category = document.getElementById('fixed-task-category').value;
            if (text && category) {
                fixedTasks.push({ text, time, category });
                saveFixedTasks();
                renderFixedTasksList();
                e.target.reset();
            }
        });

        document.getElementById('fixed-tasks-list').addEventListener('click', (e) => {
            const removeBtn = e.target.closest('.remove-fixed-task-btn');
            if (removeBtn) {
                const index = Number(removeBtn.dataset.index);
                fixedTasks.splice(index, 1);
                saveFixedTasks();
                renderFixedTasksList();
            }
        });


        // --- INICIALIZA√á√ÉO ---
        function init() {
            displayDate();
            
            const fixedTaskCategorySelect = document.getElementById('fixed-task-category');
            Object.keys(categoryConfig).forEach(cat => {
                if (cat !== 'geral' && cat !== 'historico' && cat !== 'configuracoes') {
                    renderCategoryTab(cat);
                    const option = document.createElement('option');
                    option.value = cat;
                    option.textContent = categoryConfig[cat].title;
                    fixedTaskCategorySelect.appendChild(option);
                }
            });

            loadFixedTasks();
            loadTasks();
            loadHistory();
            renderAll();
            document.querySelector('.tab-button[data-tab="geral"]').click();
            document.querySelector('.history-sub-tab-button[data-subtab="lista"]').click();
        }

        init();
    });
    </script>
</body>
</html>
